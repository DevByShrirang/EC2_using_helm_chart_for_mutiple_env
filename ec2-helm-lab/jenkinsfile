pipeline {
  agent any

  environment {
    GIT_REPO = "https://github.com/DevByShrirang/EC2_using_helm_chart_for_mutiple_env.git"
    APP_NAME = "ec2-helm-lab"
    AWS_REGION = "us-east-2"
  }

  stages {

    stage('Checkout Repository') {
      steps {
        echo "ğŸ”¹ Cloning Helm chart repository..."
        git branch: 'main', url: "${GIT_REPO}"
      }
    }

    // ========== DEV ENVIRONMENT ========== //
    stage('Deploy to Dev') {
      steps {
        dir("${APP_NAME}") {
          echo "ğŸš€ Rendering Helm templates for DEV environment..."
          sh """
            helm template ${APP_NAME}-dev ./ -f values-dev.yaml > rendered-dev.yaml
            echo 'âœ… DEV environment simulated deployment complete'
            cat rendered-dev.yaml
          """
        }
      }
    }

    stage('Create EC2 for Dev') {
      steps {
        dir("${APP_NAME}") {
          echo "âš™ï¸ Creating EC2 instance for DEV..."
          sh '''
            # Extract and execute AWS CLI commands from Helm output
            grep "aws ec2 run-instances" rendered-dev.yaml | sed "s/^.*aws/aws/" > launch-dev.sh
            chmod +x launch-dev.sh
            echo "ğŸ”¹ Launching EC2 instance..."
            ./launch-dev.sh || echo "âš ï¸ No EC2 creation command found in rendered-dev.yaml"
          '''
        }
      }
    }

    // ========== STAGE ENVIRONMENT ========== //
    stage('Approval for Stage') {
      steps {
        timeout(time: 15, unit: 'MINUTES') {
          input message: "ğŸŸ¡ Approve promotion from DEV â†’ STAGE?"
        }
      }
    }

    stage('Deploy to Stage') {
      steps {
        dir("${APP_NAME}") {
          echo "ğŸš€ Rendering Helm templates for STAGE environment..."
          sh """
            helm template ${APP_NAME}-stage ./ -f values-stage.yaml > rendered-stage.yaml
            echo 'âœ… STAGE environment simulated deployment complete'
            cat rendered-stage.yaml
          """
        }
      }
    }

    stage('Create EC2 for Stage') {
      steps {
        dir("${APP_NAME}") {
          echo "âš™ï¸ Creating EC2 instance for STAGE..."
          sh '''
            grep "aws ec2 run-instances" rendered-stage.yaml | sed "s/^.*aws/aws/" > launch-stage.sh
            chmod +x launch-stage.sh
            echo "ğŸ”¹ Launching EC2 instance..."
            ./launch-stage.sh || echo "âš ï¸ No EC2 creation command found in rendered-stage.yaml"
          '''
        }
      }
    }

    // ========== PROD ENVIRONMENT ========== //
    stage('Approval for Prod') {
      steps {
        timeout(time: 15, unit: 'MINUTES') {
          input message: "ğŸ”´ Approve promotion from STAGE â†’ PROD?"
        }
      }
    }

    stage('Deploy to Prod') {
      steps {
        dir("${APP_NAME}") {
          echo "ğŸš€ Rendering Helm templates for PROD environment..."
          sh """
            helm template ${APP_NAME}-prod ./ -f values-prod.yaml > rendered-prod.yaml
            echo 'âœ… PROD environment simulated deployment complete'
            cat rendered-prod.yaml
          """
        }
      }
    }

    stage('Create EC2 for Prod') {
      steps {
        dir("${APP_NAME}") {
          echo "âš™ï¸ Creating EC2 instance for PROD..."
          sh '''
            grep "aws ec2 run-instances" rendered-prod.yaml | sed "s/^.*aws/aws/" > launch-prod.sh
            chmod +x launch-prod.sh
            echo "ğŸ”¹ Launching EC2 instance..."
            ./launch-prod.sh || echo "âš ï¸ No EC2 creation command found in rendered-prod.yaml"
          '''
        }
      }
    }
  }

  post {
    success {
      echo "ğŸ¯ All environments promoted successfully and EC2s launched!"
    }
    failure {
      echo "âŒ Promotion failed. Please check the previous stage."
    }
  }
}
