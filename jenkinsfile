pipeline {
  agent any

  environment {
    GIT_REPO = "https://github.com/DevByShrirang/EC2_using_helm_chart_for_mutiple_env.git"
    APP_NAME = "ec2-helm-lab"
  }

  stages {

    stage('Checkout Repository') {
      steps {
        echo "ğŸ”¹ Cloning Helm chart repository..."
        git branch: 'main', url: "${GIT_REPO}"
      }
    }

    stage('Deploy to Dev') {
      steps {
        echo "ğŸš€ Deploying to DEV environment..."
        sh """
          helm template ${APP_NAME}-dev ./ -f values-dev.yaml > rendered-dev.yaml
          echo 'âœ… DEV environment simulated deployment complete'
          cat rendered-dev.yaml
        """
      }
    }

    stage('Approval for Stage') {
      steps {
        timeout(time: 15, unit: 'MINUTES') {
          input message: "ğŸŸ¡ Approve promotion from DEV â†’ STAGE?"
        }
      }
    }

    stage('Deploy to Stage') {
      steps {
        echo "ğŸš€ Deploying to STAGE environment..."
        sh """
          helm template ${APP_NAME}-stage ./ -f values-stage.yaml > rendered-stage.yaml
          echo 'âœ… STAGE environment simulated deployment complete'
          cat rendered-stage.yaml
        """
      }
    }

    stage('Approval for Prod') {
      steps {
        timeout(time: 15, unit: 'MINUTES') {
          input message: "ğŸ”´ Approve promotion from STAGE â†’ PROD?"
        }
      }
    }

    stage('Deploy to Prod') {
      steps {
        echo "ğŸš€ Deploying to PROD environment..."
        sh """
          helm template ${APP_NAME}-prod ./ -f values-prod.yaml > rendered-prod.yaml
          echo 'âœ… PROD environment simulated deployment complete'
          cat rendered-prod.yaml
        """
      }
    }
  }

  post {
    success {
      echo "ğŸ¯ All environments promoted successfully!"
    }
    failure {
      echo "âŒ Promotion failed. Please check the previous stage."
    }
  }
}
